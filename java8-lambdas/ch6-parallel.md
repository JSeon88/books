## 데이터 병렬 처리

> 람다식과 스트림 라이브러리를 사용한 병렬 처리 vs 이전 버전 자바의 병렬 처리<br>
> 차이점 : 무엇을 만드는가에 초점을 두는 것이 아닌 무엇을 어떻게 만들어야 하는가에 중점

### 병렬성 vs 동시성

- 병렬성
  - 실제 같은 시간에 함께 수행되는 것.
  - 멀티 코어 CPU에서 태스크들이 각각 다른 CPU에 독립적으로 할당되어 실행되는 것
- 동시성
  - 두 개의 태스크(task)가 서로 중첩이 되는 시간에 각각 수행되는 것.
  - CPU를 작은 수행시간으로 나누어 두 개의 태스크를 순차적으로 실행하는 방식.

### 병렬 처리의 목적

- 특정 태스크를 작은 컴포넌트로 나누어 동시에 수행하여 전체 태스크의 실행시간(런티임)을 줄이는 것
- 똑같은 연산을 많은 양의 데이터에 수행할 때 빛을 발함
- 병렬 처리를 수행하기 위해 가장 중요한 부분은 연산을 시작하기 전에 어떠한 방식으로 데이터를 나눌지, 그리고 연산이 끝난 후 어떻게 다시 합치는 지다.

### 병렬 처리가 중요한 이유

> 암달의 법칙 : 멀티코어에서 동작하는 프로그램의 최고 성능을 이론적으로 예상하는 간단한 법칙

- 멀티코어 시대에 많은 수의 코어를 최대로 활용하기 위해서는 병렬 프로그래밍을 제대로 이해하고 활용하여 프로그램 수행 성능을 저하하는 부분을 단계적으로 해결해나가야 함.

### 병렬 처리 스트림 연산

> parallel

- 앨범의 모든 트랙 길이의 합을 구하는 코드

```java
public int serialArraySum() {
    return albums.stream()
                 .flatMap(Album::getTracks)
                 .mapToInt(Track::getLength)
                 .sum();
}
```

- 앨범 트랙 길이의 합을 병렬 처리로 구하기

```java
public int parallelArraySum() {
    return albums.parallelStream()
                 .flatMap(Album::getTracks)
                 .mapToInt(Track::getLength)
                 .sum();
}
```

### 병렬 처리 스트림의 성능에 영향을 주는 다섯 가지

- 데이터 크기
  - 입력 데이터의 크기에 따라서 병렬 처리의 효과가 달라짐
- 소스 데이터 구조
  - 데이터 구조를 쉽게 나눌 수 있는 소스 데이터
  - ArrayList, array, IntStream.range..etc
- 객체화
  - 원시 타입의 연산 속도는 박스 타입보다 빠르다
- 코어의 개수
  - 코드를 실행 할 때 몇개의 코어를 사용할 수 있는지.
  - 동시에 수행되는 다른 프로세스가 있거나 스레드 친밀성을 준다면 이들은 성능에 영향을 줌
- 각 엘리먼트에 드는 비용
  - 스트림에서 가장 오래 걸리는 연산이 각 엘리먼트를 처리하면 연산이라면, 병렬 처리를 사용하여 확실한 성능 개선을 할 수 있음.

#### 포크-조인

> 포크 : 엘리멘트를 재귀적으로 나눔 <br>
> 조인 : 결과를 다시 합침

즉, 데이터 구조를 반복적으로 반으로 나누는 연산이 얼마나 잘 수행되는지에 따라 전체 연산의 성능이 좌우된다.

- 좋음
  - ArrayList, array, IntStream.range
- 그럭저럭 괜찮음
  - HashSet, TreeSet
- 나쁨
  - LinkedList, Stream.iterate, BufferedReader.lines 등

#### 비상태유지 연산, 상태유지 연산

- 비상태유지 연산
  - 전체 연산에서 상태를 유지할 필요 없음
  - map, filter, flatMap
- 상태유지 연산
  - 상태를 유지하기 위해 오버헤드가 생김.
  - sorted, distinct, limit

### 병렬 배열 연산

| 이름           | 연산                                       |
| -------------- | ------------------------------------------ |
| parallelPrefix | 배열의 모든 값을 주어진 임의의 함수로 계산 |
| parallelSetAll | 람다식으로 배열의 값을 업데이트            |
| parallelSort   | 병렬 처리로 엘리먼트를 정렬                |
